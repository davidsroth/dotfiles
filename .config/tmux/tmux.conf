# ============================================================================
# Tmux Configuration - Main Entry Point
# ============================================================================

# Terminal Configuration
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB,xterm-kitty:RGB,alacritty:RGB,wezterm:RGB"

# Yazi/tmux: passthrough + env for accurate terminal responses
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Performance Settings
set -g repeat-time 0
set -g focus-events on
set -sg escape-time 0
set -g display-time 2000

# ============================================================================
# General Settings
# ============================================================================

# Mouse support
set -g mouse on

# Window and pane indexing
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# History and clipboard
set -g history-limit 50000
set -g set-clipboard on

# Session behavior
set -g detach-on-destroy off
set -g monitor-activity off
set -g visual-activity off

# Popup appearance
set -g popup-border-lines rounded

# ============================================================================
# Key Bindings
# ============================================================================

# Prefix key
unbind C-b
set -g prefix C-g
bind C-g send-prefix

# Vi mode
setw -g mode-keys vi

# Window titles
set -g set-titles on
set -g set-titles-string "#T"

# ============================================================================
# Status Bar
# ============================================================================

set -g status on
set -g status-interval 5
set -g status-position bottom
set -g status-justify left

# ============================================================================
# Load Configuration Modules
# ============================================================================

# Platform-specific settings
if-shell "uname -s | grep -q Darwin" "source ~/.config/tmux/macos.conf"

# Modular configurations
source ~/.config/tmux/keybindings.conf
source ~/.config/tmux/utility.conf
source ~/.config/tmux/statusline.conf
# Source custom chord bindings under XDG config
source ~/.config/tmux/tmux-c-chords.conf
set -ga command-alias "open-recent=run-shell \"$HOME/.config/opencode/bin/open-recent-tmux.sh\""

# ============================================================================
# Plugin Configuration
# ============================================================================

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

# Core plugins
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sainnhe/tmux-fzf'

# tmux-fzf configuration
TMUX_FZF_LAUNCH_KEY="C-f"
TMUX_FZF_ORDER="session|window|pane|command|keybinding"
TMUX_FZF_PREVIEW=1

# Initialize plugin manager (keep at bottom)
# Prefer standard TPM location under ~/.tmux; guarded fallback to vendored copy
if-shell '[ -f "$HOME/.tmux/plugins/tpm/tpm" ]' \
  'run-shell "$HOME/.tmux/plugins/tpm/tpm"' \
  'if-shell "[ -f \"$HOME/.config/tmux/plugins/tpm/tpm\" ]" \
     "run-shell \"$HOME/.config/tmux/plugins/tpm/tpm\"" \
     "display-message \"TPM not found at ~/.tmux/plugins/tpm or ~/.config/tmux/plugins/tpm; install with: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm\""'

# Ensure our lazygit binding wins over any plugin defaults
unbind g
bind -r g display-popup -d '#{pane_current_path}' -w80% -h80% -E lazygit
